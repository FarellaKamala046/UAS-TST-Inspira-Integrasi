<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Inspira</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
      :root {
        --main-bg: #fff9fb;
        --text-dark: #333;
        --text-muted: #888;
        --accent-pink: #ff4d8d;
      }

      body {
        background-color: var(--main-bg);
        font-family: "Plus Jakarta Sans", sans-serif;
        color: var(--text-dark);
      }

      /* --- HEADER (SAMA PERSIS KAYA INDEX.HTML) --- */
      .navbar-custom {
        background: white;
        box-shadow: 0 1px 10px rgba(0, 0, 0, 0.05);
        padding: 10px 30px;
        height: 74px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .brand-wrapper {
        display: flex;
        height: 74px;
        align-items: center;
        gap: 6x;
        line-height: 1;
        text-decoration: none;
      }

      .header-logo {
        width: auto;
        height: 50px;
        transform: translateX(4px);
      }

      .brand-inspira {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        font-size: 2rem;
        line-height: 1.15;
        display: inline-flex;
        align-items: center;
        padding-top: 2px;
        background: linear-gradient(to right, #c62828, #e91e63, #ff8fa3);
        transform: translateY(1px);
        margin-top: -10px;
        margin-left: -7px;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .nav-link-custom {
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 700;
        font-size: 0.95rem;
        transition: color 0.2s;
      }
      .nav-link-custom:hover {
        color: var(--accent-pink);
      }
      .nav-link-custom.active {
        color: var(--accent-pink) !important;
        border-bottom: 2px solid var(--accent-pink);
        padding-bottom: 3px;
      }
      .btn-logout-custom {
        background: none;
        border: 1px solid #ddd;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #dc3545;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-logout-custom:hover {
        background: #fff5f5;
        border-color: #dc3545;
      }

      /* --- PROFILE --- */
      .profile-header {
        padding: 50px 0 30px;
        text-align: center;
      }
      .avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(45deg, #ffe0e9, #ffb3c6);
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
      }

      .album-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 22px;
        padding-bottom: 60px;
      }
      @media (min-width: 768px) {
        .album-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (min-width: 1200px) {
        .album-grid {
          grid-template-columns: repeat(5, 1fr);
        }
      }

      .album-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
        position: relative;
        transition: transform 0.2s;
        cursor: pointer;
      }
      .album-card:hover {
        transform: translateY(-1px);
      }

      .img-box {
        width: 100%;
        aspect-ratio: 3/4;
        overflow: hidden;
        background: #f3f3f3;
      }
      .album-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .btn-unpin {
        position: absolute;
        top: 12px;
        right: 12px;
        background: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ff4d4d;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transition: 0.2s;
        z-index: 10;
      }
      .album-card:hover .btn-unpin {
        opacity: 1;
      }

      .album-info {
        padding: 12px;
      }

      /* --- Modal product list --- */
      .product-row {
        display: flex;
        gap: 12px;
        padding: 12px;
        border: 1px solid #f5f5f5;
        border-radius: 16px;
        margin-bottom: 12px;
        align-items: center;
        background: white;
      }
      .product-img {
        width: 65px;
        height: 65px;
        border-radius: 10px;
        object-fit: cover;
        background: #f3f3f3;
        flex: 0 0 auto;
      }
      .btn-open {
        background: var(--accent-pink);
        color: white;
        border-radius: 999px;
        padding: 8px 14px;
        font-weight: 800;
        text-decoration: none;
        font-size: 0.82rem;
        white-space: nowrap;
      }
      .btn-open:hover {
        background: #e63e76;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 10px 0;
        color: var(--text-muted);
      }
    </style>
  </head>

  <body>
    <nav class="navbar-custom">
      <a href="index.html" class="brand-wrapper">
        <img src="./logo-inspira.png" alt="Inspira Logo" class="header-logo" />
        <span class="brand-inspira">Inspira</span>
      </a>

      <div class="nav-actions">
        <a href="index.html" class="nav-link-custom">Home</a>
        <a href="profile.html" class="nav-link-custom active">Profile</a>
        <button onclick="logout()" class="btn-logout-custom">Logout</button>
      </div>
    </nav>

    <div class="container">
      <div class="profile-header">
        <div class="avatar">ðŸŒ¸</div>
        <h2 class="fw-bold" id="user-display-name">Loading...</h2>
      </div>

      <div id="profile-gallery" class="album-grid"></div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 24px; border: none">
          <div class="modal-header border-0">
            <div>
              <h4 class="fw-bold mb-0" id="mTitle"></h4>
              <p class="text-muted small mb-0" id="mUser"></p>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5 mb-3 text-center">
                <img
                  id="mImg"
                  class="img-fluid rounded-4 shadow-sm"
                  src=""
                  alt=""
                />
              </div>
              <div class="col-md-7">
                <h6 class="fw-bold">Description</h6>
                <p id="mDesc" class="text-muted mb-4"></p>

                <h6 class="fw-bold mb-3">Get the Look</h6>
                <div id="mProducts"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_SAVED =
        "https://inspira-container.otwdochub.my.id/api/my-saved";
      const API_DELETE = "https://inspira-container.otwdochub.my.id/api/pins";
      const API_PRODUCTS = "https://clothify.otwdochub.my.id/products";

      const userId = localStorage.getItem("id");
      const userName = localStorage.getItem("user_name");
      const token = localStorage.getItem("token");

      if (!userId) window.location.href = "auth.html";
      document.getElementById("user-display-name").innerText =
        userName || "Inspira User";

      const normalize = (s) =>
        (s ?? "").toString().trim().toLowerCase().replace(/\s+/g, " ");

      const toIDR = (n) => {
        const num = Number(n);
        if (Number.isNaN(num)) return "";
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          maximumFractionDigits: 0,
        }).format(num);
      };

      // ambil look_data kalau API ngirimnya nested / string JSON
      function normalizePin(pin) {
        let lookData = pin?.look_data;

        if (typeof lookData === "string") {
          try {
            lookData = JSON.parse(lookData);
          } catch (e) {
            lookData = null;
          }
        }

        // merge: field langsung di pin tetep kepake, tapi look_data bisa ngisi yang kosong
        const merged = {
          ...pin,
          ...(lookData && typeof lookData === "object" ? lookData : {}),
        };

        // pastiin tipe aman
        merged.title = merged.title ?? "";
        merged.description = merged.description ?? "";
        merged.user = merged.user ?? ""; // ini harus username ORANG ITU (bukan username kamu)
        merged.image_url = merged.image_url ?? "";
        merged.tags = merged.tags ?? null;
        merged.item_details = merged.item_details ?? null;

        return merged;
      }

      function productTagsArray(product) {
        if (!product?.tags) return [];
        return product.tags
          .split(",")
          .map((t) => normalize(t))
          .filter(Boolean);
      }

      // STRICT MATCHING (kalau item_details ada). Kalau gak ada, ya memang gak bisa strict-match.
      function getStrictMatches(look, products) {
        let details = look?.item_details;

        // handle kalau item_details string JSON
        if (typeof details === "string") {
          try {
            details = JSON.parse(details);
          } catch (e) {
            details = null;
          }
        }

        if (!details || !Array.isArray(details)) return [];

        const matchedProducts = [];
        details.forEach((item) => {
          const lookItemTags = (item?.tags || [])
            .map((t) => normalize(t))
            .filter(Boolean)
            .sort();

          const found = products.find((p) => {
            const pTags = productTagsArray(p).sort();
            if (lookItemTags.length !== pTags.length) return false;
            return lookItemTags.every((val, idx) => val === pTags[idx]);
          });

          if (found) matchedProducts.push(found);
        });

        return matchedProducts;
      }

      async function loadProfile() {
        const gallery = document.getElementById("profile-gallery");

        try {
          const [resPins, resProd] = await Promise.all([
            fetch(`${API_SAVED}/${userId}`),
            fetch(API_PRODUCTS),
          ]);

          const pinsRaw = (await resPins.json()).data || [];
          const products = (await resProd.json()).products || [];

          const pins = pinsRaw.map(normalizePin);

          if (pins.length === 0) {
            gallery.innerHTML = `
  <div class="w-100 d-flex flex-column align-items-center justify-content-center text-center py-5" style="grid-column: 1 / -1;">
    <div class="text-muted" style="max-width: 420px; line-height: 1.6;">
      Belum ada OOTD yang disimpan.
    </div>
  </div>
`;
            return;
          }

          window.__SAVED_DATA__ = pins;
          window.__GLOBAL_PRODUCTS__ = products;

          gallery.innerHTML = pins
            .map(
              (pin) => `
                <div class="album-card" onclick="openDetail(${pin.id})">
                  <button class="btn-unpin" onclick="handleUnpin(event, ${
                    pin.id
                  })" title="Remove">
                    <i data-feather="trash-2"></i>
                  </button>
                  <div class="img-box">
                    <img src="${pin.image_url}" class="album-img" alt="${String(
                pin.title || "Saved look"
              ).replace(/"/g, "&quot;")}" loading="lazy">
                  </div>
                  <div class="album-info">
                    <p class="fw-bold mb-0">${pin.title || "-"}</p>
                  </div>
                </div>
              `
            )
            .join("");

          feather.replace();
        } catch (err) {
          console.error(err);
          gallery.innerHTML =
            '<p class="text-center w-100 text-danger py-5">Gagal memuat data.</p>';
        }
      }

      async function handleUnpin(event, pinId) {
        event.stopPropagation();
        if (!confirm("Hapus outfit ini?")) return;

        try {
          const res = await fetch(`${API_DELETE}/${pinId}`, {
            method: "DELETE",
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });

          if (res.ok) {
            alert("Berhasil dihapus!");
            loadProfile();
          } else {
            let msg = "Gagal hapus.";
            try {
              const data = await res.json();
              if (data?.message) msg = data.message;
            } catch (e) {}
            alert(`âš ï¸ ${msg}`);
          }
        } catch (e) {
          alert("âš ï¸ Server tidak merespon.");
        }
      }

      function openDetail(pinId) {
        const pin = (window.__SAVED_DATA__ || []).find((p) => p.id == pinId);
        const products = window.__GLOBAL_PRODUCTS__ || [];
        if (!pin) return;

        // ini yang kamu mau: username harus username ORANG ITU (dari pin.user), bukan username kamu
        const displayUser = pin.user ? `@${pin.user}` : "@unknown";

        document.getElementById("mTitle").innerText = pin.title || "No Title";
        document.getElementById("mUser").innerText = displayUser;
        document.getElementById("mImg").src = pin.image_url || "";
        document.getElementById("mDesc").innerText =
          pin.description || "No description provided.";

        const matches = getStrictMatches(pin, products);
        const pBody = document.getElementById("mProducts");

        if (!matches.length) {
          pBody.innerHTML = `<div class="empty-state">No items matched.</div>`;
        } else {
          pBody.innerHTML = matches
            .map(
              (p) => `
              <div class="product-row">
                <img class="product-img" src="${
                  p.image_url || ""
                }" alt="${String(p.name || "product").replace(
                /"/g,
                "&quot;"
              )}" loading="lazy">
                <div class="flex-grow-1" style="min-width:0;">
                  <p class="fw-bold mb-0">${p.name || "-"}</p>
                  <p class="text-muted small mb-0">${p.brand || "â€”"} â€¢ ${
                p.category || "â€”"
              }</p>
                  <div class="fw-bold mt-1">${toIDR(p.price)}</div>
                </div>
                <a href="${
                  p.product_url || "#"
                }" target="_blank" rel="noopener" class="btn-open">
                  Open
                </a>
              </div>
            `
            )
            .join("");
        }

        feather.replace();
        bootstrap.Modal.getOrCreateInstance(
          document.getElementById("detailModal")
        ).show();
      }

      function logout() {
        localStorage.clear();
        window.location.href = "auth.html";
      }

      window.addEventListener("DOMContentLoaded", loadProfile);
    </script>
  </body>
</html>
