<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Dashboard - Inspira X Clothify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { transition: all 0.3s ease; border: none; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
        .status-badge { font-size: 0.75rem; vertical-align: middle; }
        .api-url { font-family: monospace; font-size: 0.7rem; color: #6c757d; word-break: break-all; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">‚ú® Tugas 3: Integrasi Platform ‚ú®</h1>
            <p class="lead">Integrasi API OOTD (STB Armbian) & API Produk (Cloud)</p>
            <div class="d-flex justify-content-center gap-2">
                <span class="badge rounded-pill bg-dark">STB: Armbian</span>
                <span class="badge rounded-pill bg-info text-dark">SSL: Cloudflare Tunnel</span>
                <span class="badge rounded-pill bg-primary">Frontend: Vercel</span>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h3 class="h5 mb-0">üì∏ Inspiration Gallery</h3>
                        <span id="status-inspira" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                    <p class="api-url mb-3">Endpoint: https://inspira-container.otwdochub.my.id/api/looks</p>
                    
                    <div id="inspira-list">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Menghubungi STB Armbian...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h3 class="h5 mb-0">üõçÔ∏è Clothify Products</h3>
                        <span id="status-clothify" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                    <p class="api-url mb-3">Endpoint: https://clothify.otwdochub.my.id/products</p>

                    <div id="clothify-list">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-2 text-muted">Mengambil katalog produk...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi Helper untuk menangani Timeout (Jika STB lemot)
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 8000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        // --- 1. AMBIL DATA DARI STB ANDA (INSPIRA) ---
        async function loadInspira() {
            const listDiv = document.getElementById('inspira-list');
            const statusBadge = document.getElementById('status-inspira');
            
            try {
                // Menggunakan domain hyphenated yang sudah pakai SSL
                const response = await fetchWithTimeout('https://inspira-container.otwdochub.my.id/api/looks');
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                const looks = result.data || result; // Menangani jika data dibungkus .data atau array langsung

                if (!Array.isArray(looks) || looks.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-info">Database STB kosong.</div>';
                } else {
                    let html = '';
                    looks.slice(0, 5).forEach(item => {
                        html += `
                        <div class="card mb-3 border-start border-4 border-primary bg-light shadow-sm">
                            <div class="card-body py-2">
                                <h6 class="fw-bold mb-1">${item.title || 'No Title'}</h6>
                                <p class="small text-muted mb-0">${item.description || 'Tidak ada deskripsi'}</p>
                            </div>
                        </div>`;
                    });
                    listDiv.innerHTML = html;
                }
                statusBadge.className = "badge bg-success status-badge";
                statusBadge.innerText = "Online";

            } catch (err) {
                statusBadge.className = "badge bg-danger status-badge";
                statusBadge.innerText = "Error";
                
                let errorType = "Gagal Terhubung";
                if (err.name === 'AbortError') errorType = "Koneksi Timeout (STB Lemot)";
                
                listDiv.innerHTML = `
                <div class="alert alert-danger shadow-sm">
                    <strong class="d-block mb-1">‚ö†Ô∏è ${errorType}</strong>
                    <small>${err.message}</small>
                    <hr class="my-2">
                    <ul class="small mb-0 ps-3">
                        <li>Pastikan STB Armbian menyala.</li>
                        <li>Cek apakah Cloudflare Tunnel aktif.</li>
                        <li>Pastikan header CORS di BaseController.php sudah benar.</li>
                    </ul>
                </div>`;
            }
        }

        // --- 2. AMBIL DATA DARI TEMAN (CLOTHIFY) ---
        async function loadClothify() {
            const listDiv = document.getElementById('clothify-list');
            const statusBadge = document.getElementById('status-clothify');

            try {
                const response = await fetchWithTimeout('https://clothify.otwdochub.my.id/products');
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);

                const result = await response.json();
                const prods = Array.isArray(result) ? result : (result.data || []);

                if (prods.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-info">Katalog produk teman kosong.</div>';
                } else {
                    let html = '';
                    prods.slice(0, 5).forEach(p => {
                        html += `
                        <div class="card mb-3 border-start border-4 border-success bg-light shadow-sm">
                            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-0">${p.name || p.title}</h6>
                                    <small class="text-success fw-bold">Rp ${(p.price || 0).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-outline-success text-success border border-success">Produk</span>
                            </div>
                        </div>`;
                    });
                    listDiv.innerHTML = html;
                }
                statusBadge.className = "badge bg-success status-badge";
                statusBadge.innerText = "Connected";

            } catch (err) {
                statusBadge.className = "badge bg-warning text-dark status-badge";
                statusBadge.innerText = "Offline";
                listDiv.innerHTML = `
                <div class="alert alert-warning shadow-sm">
                    <strong class="d-block mb-1">‚ö†Ô∏è API Teman Tidak Merespon</strong>
                    <small>${err.message}</small>
                </div>`;
            }
        }

        // Jalankan semua fungsi saat halaman siap
        window.addEventListener('DOMContentLoaded', () => {
            loadInspira();
            loadClothify();
        });
    </script>
</body>
</html>