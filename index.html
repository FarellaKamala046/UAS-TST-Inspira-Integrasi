<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Dashboard - Inspira X Clothify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { transition: all 0.3s ease; border: none; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
        .status-badge { font-size: 0.75rem; vertical-align: middle; }
        .api-url { font-family: monospace; font-size: 0.7rem; color: #6c757d; word-break: break-all; }
        .product-price { font-weight: bold; color: #198754; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-primary">‚ú® Tugas 3: Integrasi Platform ‚ú®</h1>
            <p class="lead text-muted">Integrasi API OOTD (STB Armbian) & API Produk (Cloud)</p>
            <div class="d-flex justify-content-center gap-2">
                <span class="badge rounded-pill bg-dark">STB: Armbian</span>
                <span class="badge rounded-pill bg-info text-dark">SSL: Cloudflare Tunnel</span>
                <span class="badge rounded-pill bg-primary">Frontend: Vercel</span>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h3 class="h5 mb-0">üì∏ Inspiration Gallery</h3>
                        <span id="status-inspira" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                    <p class="api-url mb-3">Endpoint: https://inspira-container.otwdochub.my.id/api/looks</p>
                    
                    <div id="inspira-list">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted small">Menghubungi STB Armbian...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h3 class="h5 mb-0">üõçÔ∏è Clothify Products</h3>
                        <span id="status-clothify" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                    <p class="api-url mb-3">Endpoint: https://clothify.otwdochub.my.id/products</p>

                    <div id="clothify-list">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-2 text-muted small">Mengambil katalog produk...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi Helper untuk menangani Timeout agar tidak loading selamanya
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 10000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        // --- 1. AMBIL DATA DARI STB ANDA (INSPIRA) ---
        async function loadInspira() {
            const listDiv = document.getElementById('inspira-list');
            const statusBadge = document.getElementById('status-inspira');
            
            try {
                const response = await fetchWithTimeout('https://inspira-container.otwdochub.my.id/api/looks');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                // Inspira menggunakan properti "data"
                const looks = result.data || []; 

                if (looks.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-info small">Database STB kosong.</div>';
                } else {
                    let html = '';
                    looks.slice(0, 5).forEach(item => {
                        html += `
                        <div class="card mb-3 border-start border-4 border-primary bg-light shadow-sm">
                            <div class="card-body py-2">
                                <h6 class="fw-bold mb-1">${item.title || 'Untitled'}</h6>
                                <p class="small text-muted mb-0">${item.description || 'No description available'}</p>
                            </div>
                        </div>`;
                    });
                    listDiv.innerHTML = html;
                }
                statusBadge.className = "badge bg-success status-badge";
                statusBadge.innerText = "Online";

            } catch (err) {
                statusBadge.className = "badge bg-danger status-badge";
                statusBadge.innerText = "Offline/CORS Error";
                listDiv.innerHTML = `
                <div class="alert alert-danger shadow-sm py-2">
                    <strong class="d-block small">‚ö†Ô∏è Koneksi Gagal</strong>
                    <p class="mb-0 small">${err.message === 'AbortError' ? 'Timeout (STB lambat)' : err.message}</p>
                    <p class="mt-2 mb-0 x-small text-secondary">Solusi: Pastikan header OPTIONS di BaseController.php sudah dipull & container direstart.</p>
                </div>`;
            }
        }

        // --- 2. AMBIL DATA DARI TEMAN (CLOTHIFY) ---
        async function loadClothify() {
            const listDiv = document.getElementById('clothify-list');
            const statusBadge = document.getElementById('status-clothify');

            try {
                const response = await fetchWithTimeout('https://clothify.otwdochub.my.id/products');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();
                // Clothify menggunakan properti "products", bukan "data"
                const prods = result.products || []; 

                if (prods.length === 0) {
                    listDiv.innerHTML = '<div class="alert alert-info small">Katalog produk teman kosong.</div>';
                } else {
                    let html = '';
                    prods.slice(0, 5).forEach(p => {
                        html += `
                        <div class="card mb-3 border-start border-4 border-success bg-light shadow-sm">
                            <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-0 small">${p.name || p.title}</h6>
                                    <span class="product-price small">Rp ${(p.price || 0).toLocaleString()}</span>
                                </div>
                                <span class="badge bg-outline-success text-success border border-success x-small">Market</span>
                            </div>
                        </div>`;
                    });
                    listDiv.innerHTML = html;
                }
                statusBadge.className = "badge bg-success status-badge";
                statusBadge.innerText = "Connected";

            } catch (err) {
                statusBadge.className = "badge bg-warning text-dark status-badge";
                statusBadge.innerText = "Error";
                listDiv.innerHTML = `<div class="alert alert-warning py-2 small">‚ö†Ô∏è Gagal mengambil Clothify: ${err.message}</div>`;
            }
        }

        // Eksekusi saat halaman dimuat
        window.addEventListener('DOMContentLoaded', () => {
            loadInspira();
            loadClothify();
        });
    </script>
</body>
</html>